---
export const prerender = true;
import Layout from "@/layouts/main.astro";
import Sponsors from "@ui/landing/Sponsors.astro";
import { Image } from "astro:assets";

import { getCollection, render } from "astro:content";
import type { GetStaticPaths } from "astro";
import {
  defaultLang,
  showDefaultLang,
  getLangFromUrl,
  useTranslatedPath,
  useTranslations,
} from "@/i18n/utils";
import ProjectsGrid from "@/components/ProjectsGrid.astro";
import ExpressLogo from "@/components/icons/logos/express.astro";
import NodejsLogo from "@/components/icons/logos/nodejs.astro";
import WebpackLogo from "@/components/icons/logos/webpack.astro";
import OpenjsLogo from "@/components/icons/logos/openjs.astro";

export const getStaticPaths = (async () => {
  const posts = await getCollection("oss");

  const paths = posts.map((post) => {
    const parts = post.id.split("/");
    let lang: string;
    let id: string;

    if (parts.length > 1) {
      lang = parts[0];
      id = parts.slice(1).join("/");
    } else {
      lang = defaultLang;
      id = parts[0];
    }

    const realLang =
      defaultLang === lang && !showDefaultLang ? undefined : lang;

    return {
      params: { lang: realLang, id },
      props: { post },
    };
  });

  return paths;
}) satisfies GetStaticPaths;

const { post } = Astro.props;
const { Content } = await render(post);

const lang = getLangFromUrl(Astro.url);
const translatePath = useTranslatedPath(lang);
const t = useTranslations(lang);

const ICONS: Record<string, any> = {
  express: ExpressLogo,
  nodejs: NodejsLogo,
  webpack: WebpackLogo,
  openjsf: OpenjsLogo,
};
const postIdParts = post.id.split("/");
const allPosts = await getCollection("oss");
const otherPosts = allPosts
  .filter((p) => {
    const parts = p.id.split("/");
    const pLang = parts.length > 1 ? parts[0] : defaultLang;
    return p.id !== post.id && pLang === lang;
  })
  .map((p) => {
    const parts = p.id.split("/");
    const id = parts.length > 1 ? parts.slice(1).join("/") : parts[0];
    return { id, title: p.data.title, icon: ICONS[id] ?? null, slug: id };
  });
---

<Layout
  class="mx-auto mt-8 h-full max-w-[75ch] px-2"
  title={post.data.title}
  description={post.data.description}
>
  <Image
    width={728}
    height={364}
    src={translatePath(
      `/static/og/communities/${postIdParts.length > 1 ? postIdParts[1] : postIdParts[0]}`,
    )}
    alt={post.data.title}
  />
  <h1>{post.data.title}</h1>
  <main class="my-8 flex flex-col gap-y-4">
    <Content />
    <section class="flex flex-col gap-2">
      <h2>{t("landing.oss.moreProjects")}</h2>
      {(<p class="mb-3 text-sm">{t("landing.oss.moreProjectsIntro")}</p>)}
      {
        otherPosts.length > 0 && (
          <ProjectsGrid
            items={otherPosts}
            basePath="/communities"
            translatePath={translatePath}
          />
        )
      }
    </section>
    <Sponsors />
  </main>
</Layout>

<style is:inline>
  h1 {
    font-size: 2.25rem;
    line-height: 2.5rem;
    margin-bottom: 1rem;
  }

  strong {
    color: hsl(var(--primary));
  }

  main a {
    color: hsl(var(--muted-foreground));
    text-decoration: underline;
  }

  h2 {
    font-size: 1.25rem;
    line-height: 1.75rem;
  }

  main ul {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    list-style-type: disc;
    margin-left: 1.5rem;
  }

  main li {
    list-style: circle;
    margin-bottom: 0.5rem;
  }

  main li > ul {
    margin-top: 0.5rem;
  }
</style>
