---
import { ChevronDown } from "lucide-astro";
import {
  getRouteFromUrl,
  useTranslatedPath,
  getLangFromUrl,
  defaultLang,
  showDefaultLang,
} from "../i18n/utils";
import { LANGUAGES } from "../i18n/ui";

const route = getRouteFromUrl(Astro.url);
const lang = getLangFromUrl(Astro.url);
const translatePath = useTranslatedPath(lang);
const pathname = Astro.url.pathname;

function buildLocalePath(targetLang: string) {
  // If we have a named route (like `cv`) prefer translated route
  if (route) return translatePath(`/${route}`, targetLang);

  // Preserve full pathname while swapping language prefix
  const current = lang;
  const langPrefix = `/${current}/`;
  const langOnly = `/${current}`;

  let pathWithoutLang = pathname;
  if (pathname === langOnly) {
    pathWithoutLang = "/";
  } else if (pathname.startsWith(langPrefix)) {
    pathWithoutLang = pathname.slice(langOnly.length);
  }

  // If the target is default and default is hidden, return path without prefix
  if (!showDefaultLang && targetLang === defaultLang) {
    return pathWithoutLang === "" ? "/" : pathWithoutLang;
  }

  // Ensure single leading slash for the rest of the path
  const rest = pathWithoutLang === "/" ? "" : pathWithoutLang;
  return `/${targetLang}${rest}`;
}

const currentLocale = LANGUAGES[lang];
const otherLocales = Object.values(LANGUAGES).filter(
  (locale) => locale.code !== lang,
);
---

<div class="relative">
  <button
    type="button"
    id="button-lang"
    title="Change language"
    class="flex items-center gap-1 rounded-lg p-2 text-sm text-muted-foreground transition-all duration-300 hover:bg-accent hover:text-primary"
    aria-expanded="false"
    aria-haspopup="true"
  >
    {currentLocale.code.toUpperCase()}
    <ChevronDown class="size-3" />
  </button>
  <ul
    id="list-lang"
    class="absolute right-0 top-full z-50 mt-1 hidden min-w-[80px] rounded-lg border bg-background p-1 shadow-lg"
  >
    {
      otherLocales.map((locale) => (
        <li>
          <a
            href={buildLocalePath(locale.code)}
            class="block rounded-md px-3 py-1.5 text-sm text-muted-foreground transition-all duration-300 hover:bg-accent hover:text-primary"
          >
            {locale.code.toUpperCase()}
          </a>
        </li>
      ))
    }
  </ul>
</div>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    const $button = document.querySelector("#button-lang");
    const $list = document.querySelector("#list-lang");

    $button?.addEventListener("click", () => {
      $list?.classList.toggle("hidden");
      const expanded = $button.getAttribute("aria-expanded") === "true";
      $button.setAttribute("aria-expanded", String(!expanded));
    });

    document.addEventListener("click", (e) => {
      if (
        !$button?.contains(e.target as Node) &&
        !$list?.contains(e.target as Node)
      ) {
        $list?.classList.add("hidden");
        $button?.setAttribute("aria-expanded", "false");
      }
    });
  });
</script>
